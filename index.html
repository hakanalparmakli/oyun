<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Alparmaklı Ailesi Oyunu</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;
 user-select:none;-webkit-user-select:none;
 -webkit-touch-callout:none;touch-action:none}
body{background:#000;color:#fff;font-family:Arial;overflow:hidden}
canvas{display:block}

.screen{
 position:fixed;inset:0;
 display:flex;flex-direction:column;
 align-items:center;justify-content:center;
 background:#000
}

#title{font-size:34px;margin-bottom:20px}
#qrcode{background:#fff;padding:15px;border-radius:10px}
#players{margin-top:15px;font-size:22px}

input,button{
 font-size:24px;padding:12px;margin:10px
}

#mobile{
 display:none;position:fixed;inset:0;background:#000
}
.pad{
 display:grid;grid-template-columns:1fr 1fr 1fr;
 height:100%;align-items:center
}
.btn{
 width:80%;height:45%;
 margin:auto;border:4px solid #fff;
 border-radius:30px;font-size:60px;
 display:flex;align-items:center;justify-content:center
}
.jump{background:rgba(255,0,0,.35)}
</style>
</head>

<body>

<!-- HOST -->
<div id="host" class="screen">
 <div id="title">Alparmaklı Ailesi Oyunu</div>
 <div id="qrcode"></div>
 <div id="players">Oyuncular: 0</div>
</div>

<!-- MOBILE NAME -->
<div id="name" class="screen" style="display:none">
 <h1>İsmini Gir</h1>
 <input id="playerName" placeholder="İsim">
 <button id="join">KATIL</button>
</div>

<!-- MOBILE CONTROLLER -->
<div id="mobile">
 <div class="pad">
  <div id="left" class="btn">◀</div>
  <div id="jump" class="btn jump">ZIPLA</div>
  <div id="right" class="btn">▶</div>
 </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const peerParam = params.get("peer");
const peer = new Peer();

function isMobile(){
 return !!peerParam;
}

/* ================= HOST ================= */
if(!isMobile()){
 peer.on("open",id=>{
  new QRCode(document.getElementById("qrcode"),{
   text:location.href+"?peer="+id,
   width:240,height:240
  });
 });

 let count=0;
 peer.on("connection",c=>{
  c.on("data",d=>{
   if(d.type==="join"){
    count++;
    document.getElementById("players").innerText="Oyuncular: "+count;
   }
  });
 });
}

/* ================= MOBILE ================= */
else{
 document.getElementById("host").style.display="none";
 document.getElementById("name").style.display="flex";

 peer.on("open",()=>{
  const conn = peer.connect(peerParam);

  document.getElementById("join").onclick=()=>{
   const name = playerName.value.trim();
   if(!name) return alert("İsim gir");
   conn.send({type:"join",name});
   document.getElementById("name").style.display="none";
   document.getElementById("mobile").style.display="block";
  };

  const bind=(id,key)=>{
   const el=document.getElementById(id);
   let pressed=false;
   el.addEventListener("touchstart",e=>{
    e.preventDefault();
    if(!pressed){
     pressed=true;
     conn.send({type:"key",key,pressed:true});
    }
   },{passive:false});
   el.addEventListener("touchend",e=>{
    e.preventDefault();
    pressed=false;
    conn.send({type:"key",key,pressed:false});
   },{passive:false});
  };

  bind("left","left");
  bind("right","right");
  bind("jump","jump");
 });
}
</script>

</body>
</html>
