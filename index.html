<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Garantili Noel Baba</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
*{
 user-select:none;
 -webkit-user-select:none;
 -webkit-touch-callout:none;
 touch-action:none;
}
body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
canvas{display:block}

#setup,#nameScreen,#endScreen{
 position:absolute;inset:0;display:flex;
 flex-direction:column;justify-content:center;align-items:center;
 background:#000;z-index:10
}
#countdown{
 position:absolute;inset:0;display:none;
 justify-content:center;align-items:center;
 font-size:200px;font-weight:bold;z-index:20
}
#qrcode{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
#playerCount{font-size:32px;margin-top:10px}

#mobile{display:none;position:fixed;inset:0;background:#000}
.pad{
 display:grid;
 grid-template-columns:1fr 1fr 1fr;
 height:100%;
 align-items:center
}
.btn{
 font-size:60px;border:4px solid #fff;
 border-radius:30px;width:85%;height:45%;
 display:flex;justify-content:center;align-items:center;
 margin:auto
}
.jump{background:rgba(255,0,0,.3);font-size:70px}

input,button{font-size:30px;padding:15px;margin:10px}
</style>
</head>

<body>

<div id="setup">
 <div id="qrcode"></div>
 <div id="playerCount">Oyuncular: 0 / 10</div>
 <h1 id="status">BAÄžLAN</h1>
</div>

<div id="countdown"></div>

<div id="nameScreen" style="display:none">
 <h1>Ä°smini Gir</h1>
 <input id="playerName" placeholder="AdÄ±n">
 <button id="joinBtn">KATIL</button>
</div>

<div id="mobile">
 <div class="pad">
  <div id="left" class="btn">â—€</div>
  <div id="jump" class="btn jump">ZIPLA</div>
  <div id="right" class="btn">â–¶</div>
 </div>
</div>

<canvas id="c"></canvas>

<script>
document.addEventListener("contextmenu",e=>e.preventDefault());

const canvas=c;
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

const peer=new Peer();
const url=new URLSearchParams(location.search);
const peerId=url.get("peer");

const MAX=10;
let players={},gameStarted=false,waitStarted=false;
let keys={left:false,right:false,up:false};

let santa,platforms=[];
let checkpointPlatform=null;
let lastPlatformX=0;
let platformCount=0;
let countdownValue=3;

/* ================= HOST ================= */
if(!peerId){

peer.on("open",id=>{
 new QRCode(qrcode,{
  text:location.href+"?peer="+id,
  width:250,height:250
 });
});

peer.on("connection",c=>{
 c.on("data",data=>{
  if(data.type==="join"){
   players[c.peer]={name:data.name};
   const count=Object.keys(players).length;
   playerCount.innerText=`Oyuncular: ${count} / ${MAX}`;
   if(count===MAX) startCountdown();
   else if(!waitStarted) waitAndCountdown();
  }
  if(data.type==="key") keys[data.key]=data.pressed;
 });
});

function waitAndCountdown(){
 waitStarted=true;
 setTimeout(startCountdown,10000);
}

function startCountdown(){
 countdown.style.display="flex";
 countdownValue=3;
 const i=setInterval(()=>{
  countdown.innerText=countdownValue;
  countdownValue--;
  if(countdownValue<0){
   clearInterval(i);
   countdown.style.display="none";
   setup.style.display="none";
   startGame();
  }
 },1000);
}

function startGame(){
 gameStarted=true;
 initGame();
}

/* ================= GAME ================= */
function initGame(){
 santa={x:100,y:200,w:80,h:90,vx:0,vy:0,ground:false};
 platforms=[];
 lastPlatformX=0;
 platformCount=0;

 addPlatform(true); // ilk checkpoint
 for(let i=0;i<10;i++) addPlatform();

 checkpointPlatform=platforms[0];
 requestAnimationFrame(loop);
}

function addPlatform(forceCheckpoint=false){
 let gap=220+Math.random()*140;
 let x=lastPlatformX+gap;
 let y=Math.max(220,canvas.height-200+(Math.random()-0.5)*160);
 let w=260+Math.random()*180;

 platformCount++;
 let isCheckpoint = forceCheckpoint || platformCount % 12 === 0;

 const p={x,y,w,h:30,checkpoint:isCheckpoint};
 platforms.push(p);
 lastPlatformX=x+w;
}

function loop(){
 if(!gameStarted)return;

 if(santa.x+canvas.width>lastPlatformX-800){
  addPlatform();
 }

 if(keys.left)santa.vx=-10;
 else if(keys.right)santa.vx=10;
 else santa.vx*=0.8;

 if(keys.up && santa.ground){
  santa.vy=-20;
  santa.ground=false;
 }

 santa.vy+=0.6;
 santa.x+=santa.vx;
 santa.y+=santa.vy;
 santa.ground=false;

 platforms.forEach(p=>{
  if(santa.vy>=0 &&
     santa.x<p.x+p.w &&
     santa.x+santa.w>p.x &&
     santa.y+santa.h>p.y &&
     santa.y+santa.h<p.y+p.h+20){
   santa.ground=true;
   santa.vy=0;
   santa.y=p.y-santa.h;

   if(p.checkpoint){
    checkpointPlatform=p; // ðŸ”¥ PLATFORMUN KENDÄ°SÄ°
   }
  }
 });

 if(santa.y>canvas.height+200 && checkpointPlatform){
  santa.x = checkpointPlatform.x + checkpointPlatform.w/2 - santa.w/2;
  santa.y = checkpointPlatform.y - santa.h;
  santa.vx = 0;
  santa.vy = 0;
  santa.ground = true;
 }

 draw();
 requestAnimationFrame(loop);
}

function draw(){
 ctx.fillStyle="#000";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 ctx.save();
 ctx.translate(-santa.x+150,0);

 platforms.forEach(p=>{
  ctx.fillStyle=p.checkpoint?"#0f0":"#0ff";
  ctx.fillRect(p.x,p.y,p.w,p.h);
  if(p.checkpoint){
   ctx.font="40px Arial";
   ctx.fillText("ðŸš©",p.x+p.w/2,p.y-10);
  }
 });

 ctx.font="120px Arial";
 ctx.fillText("ðŸŽ…",santa.x,santa.y+100);

 ctx.restore();
}

/* ================= MOBILE ================= */
}else{

setup.style.display="none";
nameScreen.style.display="flex";

peer.on("open",()=>{
 const conn=peer.connect(peerId);

 joinBtn.onclick=()=>{
  conn.send({type:"join",name:playerName.value});
  nameScreen.style.display="none";
  mobile.style.display="block";
 };

 const bind=(id,key)=>{
  const e=document.getElementById(id);
  e.addEventListener("touchstart",ev=>{
   ev.preventDefault();
   conn.send({type:"key",key,pressed:true});
  },{passive:false});
  e.addEventListener("touchend",ev=>{
   ev.preventDefault();
   conn.send({type:"key",key,pressed:false});
  },{passive:false});
 };

 bind("left","left");
 bind("right","right");
 bind("jump","up");
});
}
</script>

</body>
</html>
