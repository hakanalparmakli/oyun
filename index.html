<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Garantili Noel Baba</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
canvas{display:block}
#setup,#nameScreen,#endScreen{
 position:absolute;inset:0;display:flex;
 flex-direction:column;justify-content:center;align-items:center;
 background:#000;z-index:10
}
#countdown{
 position:absolute;inset:0;display:none;
 justify-content:center;align-items:center;
 font-size:200px;font-weight:bold;z-index:20
}
#qrcode{background:#fff;padding:20px;border-radius:10px}
#mobile{display:none;position:fixed;inset:0;background:#000}
.pad{display:flex;height:100%}
.side{flex:1;display:flex;justify-content:center;align-items:center}
.btn{
 font-size:60px;border:4px solid #fff;border-radius:30px;
 margin:10px;width:90%;height:40%;
 display:flex;justify-content:center;align-items:center
}
.jump{flex:2;background:rgba(255,0,0,.3)}
input,button{font-size:30px;padding:15px;margin:10px}
</style>
</head>

<body>

<div id="setup">
 <div id="qrcode"></div>
 <h1 id="status">BAÄžLAN</h1>
</div>

<div id="countdown"></div>

<div id="nameScreen" style="display:none">
 <h1>Ä°smini Gir</h1>
 <input id="playerName" placeholder="AdÄ±n">
 <button id="joinBtn">KATIL</button>
</div>

<div id="mobile">
 <div class="pad">
  <div class="side"><div id="left" class="btn">â—€</div></div>
  <div id="jump" class="btn jump">ZIPLA</div>
  <div class="side"><div id="right" class="btn">â–¶</div></div>
 </div>
</div>

<div id="endScreen" style="display:none"></div>

<canvas id="c"></canvas>

<script>
const canvas=c;
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

const peer=new Peer();
const url=new URLSearchParams(location.search);
const peerId=url.get("peer");

const MAX=10;
let players={},finishedPlayers=0;
let gameStarted=false,waitStarted=false;
let keys={left:false,right:false,up:false};

let santa,platforms,gifts;
let checkpoint={x:0,y:0};

let countdownValue=3;

/* ================= HOST ================= */
if(!peerId){

peer.on("open",id=>{
 new QRCode(qrcode,{
  text:location.href+"?peer="+id,
  width:250,height:250
 });
});

peer.on("connection",c=>{
 c.on("data",data=>{
  if(data.type==="join"){
   players[c.peer]={name:data.name,score:0,finished:false};
   status.innerText=`Oyuncular: ${Object.keys(players).length}/${MAX}`;
   if(Object.keys(players).length===MAX) startCountdown();
   else if(!waitStarted) waitAndCountdown();
  }
  if(data.type==="key") keys[data.key]=data.pressed;
 });
});

function waitAndCountdown(){
 waitStarted=true;
 setTimeout(startCountdown,10000);
}

function startCountdown(){
 countdown.style.display="flex";
 countdownValue=3;
 const i=setInterval(()=>{
  countdown.innerText=countdownValue;
  countdownValue--;
  if(countdownValue<0){
   clearInterval(i);
   countdown.style.display="none";
   setup.style.display="none";
   startGame();
  }
 },1000);
}

function startGame(){
 gameStarted=true;
 initGame();
}

/* ================= GAME ================= */
function initGame(){
 santa={x:100,y:200,w:80,h:90,vx:0,vy:0,ground:false};
 platforms=[{x:0,y:canvas.height-120,w:800,h:30,checkpoint:true}];
 gifts=[];
 checkpoint={x:50,y:canvas.height-300};
 for(let i=0;i<25;i++) spawn();
 requestAnimationFrame(loop);
}

function spawn(){
 let last=platforms[platforms.length-1];
 let gap=120+Math.random()*120; // ARALAR AÃ‡IK
 let x=last.x+last.w+gap;
 let y=Math.max(220,last.y+(Math.random()-0.5)*120);
 let w=250+Math.random()*200;
 let isCheckpoint=Math.random()<0.2;
 platforms.push({x,y,w,h:30,checkpoint:isCheckpoint});
 gifts.push({x:x+w/2,y:y-80,active:true});
}

function loop(){
 if(!gameStarted)return;

 if(keys.left)santa.vx=-10;
 else if(keys.right)santa.vx=10;
 else santa.vx*=0.8;

 if(keys.up && santa.ground){
  santa.vy=-20; // ZIPLAMA KISILDI
  santa.ground=false;
 }

 santa.vy+=0.6;
 santa.x+=santa.vx;
 santa.y+=santa.vy;
 santa.ground=false;

 platforms.forEach(p=>{
  if(santa.vy>=0 &&
     santa.x<p.x+p.w &&
     santa.x+santa.w>p.x &&
     santa.y+santa.h>p.y &&
     santa.y+santa.h<p.y+p.h+20){
   santa.ground=true;
   santa.vy=0;
   santa.y=p.y-santa.h;
   if(p.checkpoint){
    checkpoint.x=p.x+20;
    checkpoint.y=p.y-300;
   }
  }
 });

 if(santa.y>canvas.height+200){
  santa.x=checkpoint.x;
  santa.y=checkpoint.y;
  santa.vy=0;
 }

 draw();
 requestAnimationFrame(loop);
}

function draw(){
 ctx.fillStyle="#000";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 ctx.save();
 ctx.translate(-santa.x+150,0);

 platforms.forEach(p=>{
  ctx.fillStyle=p.checkpoint?"#0f0":"#0ff";
  ctx.fillRect(p.x,p.y,p.w,p.h);
  if(p.checkpoint){
   ctx.font="40px Arial";
   ctx.fillText("ðŸš©",p.x+p.w/2,p.y-10);
  }
 });

 ctx.font="120px Arial";
 ctx.fillText("ðŸŽ…",santa.x,santa.y+100);

 ctx.restore();
}

/* ================= MOBILE ================= */
}else{

setup.style.display="none";
nameScreen.style.display="flex";

peer.on("open",()=>{
 const conn=peer.connect(peerId);

 joinBtn.onclick=()=>{
  conn.send({type:"join",name:playerName.value});
  nameScreen.style.display="none";
  mobile.style.display="block";
 };

 const bind=(id,key)=>{
  const e=document.getElementById(id);
  e.ontouchstart=()=>conn.send({type:"key",key,pressed:true});
  e.ontouchend=()=>conn.send({type:"key",key,pressed:false});
 };
 bind("left","left");
 bind("right","right");
 bind("jump","up");
});
}
</script>

</body>
</html>
