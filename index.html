<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AlparmaklÄ± Ailesi Oyunu</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
*{user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;touch-action:none}
body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
canvas{display:block}

#setup,#nameScreen,#overlay{
 position:absolute;inset:0;display:flex;
 flex-direction:column;justify-content:center;align-items:center;
 background:#000;z-index:10;text-align:center
}
#countdown{
 position:absolute;inset:0;display:none;
 justify-content:center;align-items:center;
 font-size:150px;font-weight:bold;z-index:20
}
#qrcode{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
#playerCount,#order{font-size:24px;margin-top:10px}

#mobile{display:none;position:fixed;inset:0;background:#000}
.pad{
 display:grid;
 grid-template-columns:1fr 1fr 1fr;
 height:100%;
 align-items:center
}
.btn{
 font-size:60px;border:4px solid #fff;
 border-radius:30px;width:85%;height:45%;
 display:flex;justify-content:center;align-items:center;
 margin:auto
}
.jump{background:rgba(255,0,0,.3);font-size:70px}
#lock{
 position:absolute;inset:0;display:flex;justify-content:center;align-items:center;
 background:rgba(0,0,0,.7);font-size:50px;color:#fff;z-index:5;
}
input,button{font-size:25px;padding:10px;margin:10px}
</style>
</head>

<body>

<div id="setup">
 <h1>AlparmaklÄ± Ailesi Oyunu</h1>
 <div id="qrcode"></div>
 <div id="playerCount">Oyuncular: 0</div>
 <div id="order"></div>
</div>

<div id="countdown"></div>
<div id="overlay" style="display:none"></div>

<div id="nameScreen" style="display:none">
 <h1>AlparmaklÄ± Ailesi Oyunu</h1>
 <h2>Ä°smini Gir</h2>
 <input id="playerName">
 <button id="joinBtn">KATIL</button>
</div>

<div id="mobile">
 <div id="lock">SÄ±ranÄ± Bekle</div>
 <div class="pad">
  <div id="left" class="btn">â—€</div>
  <div id="jump" class="btn jump">ZIPLA</div>
  <div id="right" class="btn">â–¶</div>
 </div>
</div>

<canvas id="c"></canvas>

<script>
document.addEventListener("contextmenu",e=>e.preventDefault());
const canvas=c,ctx=canvas.getContext("2d");
canvas.width=innerWidth; canvas.height=innerHeight;

const peer=new Peer();
const params=new URLSearchParams(location.search);
const peerId=params.get("peer");

let players=[],currentIndex=0,activePeer=null,keys={left:false,right:false,up:false};
let gameActive=false,santa,platforms=[],finishX=5000,checkpoints=[],lastCheckpointX=0;

/* ================= HOST ================= */
if(!peerId){

peer.on("open",id=>{
 let url=new URL(location.href);
 url.searchParams.set("peer",id);
 new QRCode(qrcode,{text:url.toString(),width:250,height:250});
});

peer.on("connection",c=>{
 c.on("data",d=>{
  if(d.type==="join"){
   players.push({peer:c.peer,name:d.name,score:0});
   playerCount.innerText=`Oyuncular: ${players.length}`;
   renderOrder();
   if(!gameActive) waitAndStart();
  }
  if(d.type==="key" && c.peer===activePeer){
   keys[d.key]=d.pressed;
  }
 });
});

function renderOrder(){
 order.innerHTML="<h2>Oyun SÄ±rasÄ±</h2>"+players.map((p,i)=>`${i+1}. ${p.name}`).join("<br>");
}

// Gizli bekleme: 20 saniye
function waitAndStart(){
 gameActive=true;
 let hiddenWait=20;
 const waitInterval=setInterval(()=>{
   hiddenWait--;
   if(hiddenWait<=0){
     clearInterval(waitInterval);
     startCountdown3();
   }
 },1000);
}

function startCountdown3(){
 countdown.style.display="flex";
 let count=3;
 countdown.innerText=count;
 const i=setInterval(()=>{
   count--;
   if(count>0) countdown.innerText=count;
   else{
     clearInterval(i);
     countdown.style.display="none";
     overlay.style.display="none";
     setup.style.display="none";
     startTurn();
   }
 },1000);
}

function startTurn(){
 if(currentIndex>=players.length){
  overlay.innerHTML="<h1>AlparmaklÄ± Ailesi Oyunu - Oyun Bitti!</h1>"+players
   .sort((a,b)=>b.score-a.score)
   .map((p,i)=>`${i+1}. ${p.name} - ${p.score}`).join("<br>");
  overlay.style.display="flex";
  return;
 }
 const p=players[currentIndex];
 activePeer=p.peer;
 overlay.innerHTML=`<h1>Åžimdi Oynuyor</h1><h2>${p.name}</h2>`;
 overlay.style.display="flex";

 // TÃ¼m baÄŸlÄ± oyunculara aktif peer ID gÃ¶nder
 players.forEach(pl=>{
   const conn = peer.connections[pl.peer]?.[0];
   if(conn) conn.send({type:"active",activePeerId:activePeer});
 });

 setTimeout(()=>{
  overlay.style.display="none";
  initGame();
 },1500);
}

/* ================= GAME ================= */
function initGame(){
 santa={x:50,y:200,w:80,h:90,vx:0,vy:0,ground:false};
 platforms=[{x:0,y:canvas.height-120,w:600,h:30}];
 let x=600; let count=1;
 checkpoints=[{x:300}]; // ilk checkpoint
 lastCheckpointX=0;

 while(x<finishX){
  let gap=220+Math.random()*120;
  let w=260;
  let y=canvas.height-200+(Math.random()-0.5)*120;
  platforms.push({x,y,w,h:30});
  count++;
  if(count%10===0){
   checkpoints.push({x:x+w/2});
  }
  x+=w+gap;
 }
 requestAnimationFrame(loop);
}

function loop(){
 ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);

 if(keys.left)santa.vx=-8;
 else if(keys.right)santa.vx=8;
 else santa.vx*=0.8;

 if(keys.up && santa.ground){santa.vy=-15; santa.ground=false;}

 santa.vy+=0.6;
 santa.x+=santa.vx; santa.y+=santa.vy; santa.ground=false;

 platforms.forEach(p=>{
  if(santa.vy>=0 &&
     santa.x<p.x+p.w &&
     santa.x+santa.w>p.x &&
     santa.y+santa.h>p.y &&
     santa.y+santa.h<p.y+p.h+20){
   santa.ground=true;
   santa.vy=0;
   santa.y=p.y-santa.h;
  }
 });

 checkpoints.forEach(c=>{
  if(santa.x>c.x) lastCheckpointX=c.x;
 });

 if(santa.y>canvas.height+200){
  santa.x=lastCheckpointX||50;
  santa.y=200;
  santa.vy=0;
 }

 ctx.save();
 ctx.translate(-santa.x+150,0);

 platforms.forEach(p=>{ ctx.fillStyle="#0ff"; ctx.fillRect(p.x,p.y,p.w,p.h); });
 checkpoints.forEach(c=>{ ctx.fillStyle="green"; ctx.fillRect(c.x-10,canvas.height-200,20,100); });
 ctx.fillStyle="red"; ctx.fillRect(finishX,0,10,canvas.height);

 ctx.font="120px Arial";
 ctx.fillText("ðŸŽ…",santa.x,santa.y+100);
 ctx.restore();

 if(santa.x>finishX){
  players[currentIndex].score=Math.floor(10000/Date.now()%1000);
  currentIndex++;
  keys={left:false,right:false,up:false};
  startTurn();
  return;
 }

 requestAnimationFrame(loop);
}

/* ================= MOBILE ================= */
}else{
setup.style.display="none";
nameScreen.style.display="flex";

peer.on("open",()=>{
 const conn=peer.connect(peerId);

 const sendJoin=()=>{
  const name=playerName.value.trim();
  if(!name) return alert("LÃ¼tfen isim girin");
  conn.send({type:"join",name});
  nameScreen.style.display="none";
  mobile.style.display="block";
 };

 joinBtn.addEventListener("click",sendJoin);
 joinBtn.addEventListener("touchstart",e=>{ e.preventDefault(); sendJoin(); },{passive:false});

 conn.on("data",d=>{
    if(d.type==="active"){
       const lock=document.getElementById("lock");
       if(peer.id===d.activePeerId) lock.style.display="none";
       else lock.style.display="flex";
    }
    if(d.type==="key"){
       keys[d.key]=d.pressed;
    }
 });

 ["left","right","up"].forEach((k,i)=>{
  const id=i==0?"left":i==1?"right":"jump";
  const el=document.getElementById(id);
  el.addEventListener("touchstart",e=>{
   e.preventDefault();
   if(document.getElementById("lock").style.display==="none"){
     conn.send({key:k,pressed:true,type:"key"});
   }
  },{passive:false});
  el.addEventListener("touchend",e=>{
   e.preventDefault();
   if(document.getElementById("lock").style.display==="none"){
     conn.send({key:k,pressed:false,type:"key"});
   }
  },{passive:false});
 });
});
}
</script>

</body>
</html>
