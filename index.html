<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alparmaklı Ailesi Oyunu</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
#title{font-size:36px;margin-bottom:20px}
#qrcode{background:#fff;padding:15px;border-radius:10px}
#order{margin-top:20px;font-size:22px;text-align:center}
#countdown{font-size:160px;font-weight:bold;display:none}

#name input,#name button{font-size:24px;padding:10px;margin:10px}

#mobile{display:none;position:fixed;inset:0}
.pad{display:grid;grid-template-columns:1fr 1fr 1fr;height:100%}
.btn{
 margin:auto;width:80%;height:45%;
 border:4px solid #fff;border-radius:30px;
 font-size:60px;display:flex;
 align-items:center;justify-content:center
}
.jump{background:rgba(255,0,0,.35)}
#lock{
 position:absolute;inset:0;
 display:flex;align-items:center;
 justify-content:center;
 background:rgba(0,0,0,.85);
 font-size:40px;z-index:5
}
</style>
</head>

<body>

<!-- HOST -->
<div id="host" class="screen">
 <div id="title">Alparmaklı Ailesi Oyunu</div>
 <div id="qrcode"></div>
 <div id="order"></div>
</div>

<div id="countdown" class="screen"></div>

<!-- MOBILE NAME -->
<div id="name" class="screen" style="display:none">
 <h1>İsmini Gir</h1>
 <input id="playerName">
 <button id="join">KATIL</button>
</div>

<!-- MOBILE CONTROLLER -->
<div id="mobile">
 <div id="lock">Sıranı Bekle</div>
 <div class="pad">
  <div id="left" class="btn">◀</div>
  <div id="jump" class="btn jump">ZIPLA</div>
  <div id="right" class="btn">▶</div>
 </div>
</div>

<script>
const params=new URLSearchParams(location.search);
const peerParam=params.get("peer");
const peer=new Peer();
let connections=[],players=[],activeIndex=0,activePeerId=null;
let gameStarted=false;

/* ================= HOST ================= */
if(!peerParam){
 peer.on("open",id=>{
  const qrEl=document.getElementById("qrcode");
  qrEl.innerHTML="";
  new QRCode(qrEl,{text:location.href+"?peer="+id,width:240,height:240});
  console.log("QR oluşturuldu, Peer ID:",id);

  // 20 saniye bekleme (ekranda görünmez)
  setTimeout(startCountdown,20000);
 });

 peer.on("connection",c=>{
  connections.push(c);
  c.on("data",d=>{
   if(d.type==="join"){
    players.push({id:c.peer,name:d.name});
    renderOrder();
   }
  });
 });

 function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
   const j=Math.floor(Math.random()*(i+1));
   [arr[i],arr[j]]=[arr[j],arr[i]];
  }
 }

 function renderOrder(){
  shuffle(players);
  order.innerHTML="<b>Oyun Sırası</b><br><br>"+
   players.map((p,i)=>`${i+1}. ${p.name}${i===0?" (BAŞLIYOR)":""}`).join("<br>");
  activePeerId=players[0]?.id||null;
 }

 function startCountdown(){
  host.style.display="none";
  countdown.style.display="flex";
  let n=3;
  countdown.innerText=n;
  const interval=setInterval(()=>{
   n--;
   if(n>0){
    countdown.innerText=n;
   }else{
    clearInterval(interval);
    countdown.style.display="none";
    startGame();
   }
  },1000);
 }

 function startGame(){
  gameStarted=true;
  connections.forEach(c=>c.send({type:"start",activePeerId}));
 }
}

/* ================= MOBILE ================= */
else{
 host.style.display="none";
 name.style.display="flex";

 peer.on("open",()=>{
  const conn=peer.connect(peerParam);

  join.onclick=()=>{
   const val=playerName.value.trim();
   if(!val) return alert("İsim gir");
   conn.send({type:"join",name:val});
   name.style.display="none";
   mobile.style.display="block";
  };

  conn.on("data",d=>{
   if(d.type==="start"){
    activePeerId=d.activePeerId;
    if(peer.id===activePeerId){
     lock.style.display="none"; // aktif oyuncu
    }else{
     lock.style.display="flex"; // diğerleri kilitli
    }
   }
  });

  const send=(key,pressed)=>{
   if(peer.id===activePeerId){
    if(conn.open) conn.send({type:"key",key,pressed});
   }
  };

  const bind=(id,key)=>{
   const el=document.getElementById(id);
   let pressed=false;
   el.addEventListener("touchstart",e=>{
    e.preventDefault();
    if(!pressed){
     pressed=true;send(key,true);
    }
   },{passive:false});
   el.addEventListener("touchend",e=>{
    e.preventDefault();
    pressed=false;send(key,false);
   },{passive:false});
  };

  bind("left","left");
  bind("right","right");
  bind("jump","jump");
 });
}
</script>

</body>
</html>
