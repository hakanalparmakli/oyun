<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Garantili Noel Baba</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body { margin:0; background:#000; color:#fff; font-family:Arial; overflow:hidden }
canvas { display:block }

#setup, #nameScreen, #endScreen {
 position:absolute; inset:0; display:flex;
 flex-direction:column; justify-content:center; align-items:center;
 background:#000; z-index:10;
}

#qrcode { background:#fff; padding:20px; border-radius:10px }

#mobile { display:none; position:fixed; inset:0; background:#000 }
.pad { display:flex; height:100% }
.side { flex:1; display:flex; justify-content:center; align-items:center }
.btn { font-size:60px; border:4px solid #fff; border-radius:30px;
 margin:10px; width:90%; height:40%; display:flex;
 justify-content:center; align-items:center }
.jump { flex:2; background:rgba(255,0,0,.3) }
input, button {
 font-size:30px; padding:15px; margin:10px;
}
</style>
</head>

<body>

<div id="setup">
 <div id="qrcode"></div>
 <h1 id="status">BAƒûLAN</h1>
</div>

<div id="nameScreen" style="display:none">
 <h1>ƒ∞smini Gir</h1>
 <input id="playerName" placeholder="Adƒ±n">
 <button id="joinBtn">KATIL</button>
</div>

<div id="mobile">
 <div class="pad">
  <div class="side"><div id="left" class="btn">‚óÄ</div></div>
  <div id="jump" class="btn jump">ZIPLA</div>
  <div class="side"><div id="right" class="btn">‚ñ∂</div></div>
 </div>
</div>

<div id="endScreen" style="display:none"></div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const peer = new Peer();
const url = new URLSearchParams(location.search);
const peerId = url.get("peer");

const MAX = 10;
let players = {};
let gameStarted = false;
let waitStarted = false;
let countdown = 3;

let keys = { left:false, right:false, up:false };

let santa, platforms, gifts;
let finishedPlayers = 0;

canvas.width = innerWidth;
canvas.height = innerHeight;

/* ================= HOST ================= */
if (!peerId) {

peer.on("open", id => {
 new QRCode(qrcode, {
  text: location.href + "?peer=" + id,
  width:250, height:250
 });
});

peer.on("connection", c => {
 c.on("data", data => {

  if (data.type === "join") {
   if (Object.keys(players).length >= MAX) return;

   players[c.peer] = {
    name:data.name, score:0, finished:false
   };

   status.innerText =
    `Oyuncular: ${Object.keys(players).length}/${MAX}`;

   if (Object.keys(players).length === MAX) startGame();
   else if (!waitStarted) waitForStart();
  }

  if (data.type === "key") {
   keys[data.key] = data.pressed;
  }
 });
});

function waitForStart() {
 waitStarted = true;
 setTimeout(() => {
  const i = setInterval(() => {
   status.innerText = countdown;
   countdown--;
   if (countdown < 0) {
    clearInterval(i);
    startGame();
   }
  },1000);
 },10000);
}

function startGame() {
 gameStarted = true;
 setup.style.display = "none";
 initGame();
}

/* ================= GAME ================= */
function initGame() {
 santa = { x:100,y:200,w:80,h:90,vx:0,vy:0,ground:false };
 platforms = [{x:0,y:canvas.height-120,w:2000,h:30}];
 gifts = [];
 for(let i=0;i<20;i++) spawn();
 requestAnimationFrame(loop);
}

function spawn() {
 let last = platforms[platforms.length-1];
 let x = last.x + last.w + 30;
 let y = Math.max(200, last.y + (Math.random()-0.5)*100);
 let w = 400;
 platforms.push({x,y,w,h:30});
 gifts.push({x:x+w/2,y:y-80,active:true});
}

function loop() {
 if (!gameStarted) return;

 if (keys.left) santa.vx=-12;
 else if (keys.right) santa.vx=12;
 else santa.vx*=0.8;

 if (keys.up && santa.ground) {
  santa.vy=-28; santa.ground=false;
 }

 santa.vy+=0.6;
 santa.x+=santa.vx;
 santa.y+=santa.vy;
 santa.ground=false;

 platforms.forEach(p=>{
  if (santa.vy>=0 &&
   santa.x<p.x+p.w &&
   santa.x+santa.w>p.x &&
   santa.y+santa.h>p.y &&
   santa.y+santa.h<p.y+p.h+20) {
    santa.ground=true;
    santa.vy=0;
    santa.y=p.y-santa.h;
  }
 });

 gifts.forEach(g=>{
  if (g.active &&
   Math.abs(santa.x-g.x)<60 &&
   Math.abs(santa.y-g.y)<80) {
    g.active=false;
    let p = Object.values(players).find(x=>!x.finished);
    if (p) {
     p.score++;
     if (p.score>=5) {
      p.finished=true;
      finishedPlayers++;
     }
    }
  }
 });

 if (finishedPlayers === Object.keys(players).length) endGame();

 draw();
 requestAnimationFrame(loop);
}

function draw() {
 ctx.fillStyle="#000";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 ctx.save();
 ctx.translate(-santa.x+150,0);

 platforms.forEach(p=>{
  ctx.fillStyle="#0ff";
  ctx.fillRect(p.x,p.y,p.w,p.h);
 });

 ctx.font="60px Arial";
 gifts.forEach(g=>{ if(g.active) ctx.fillText("üéÅ",g.x,g.y); });

 ctx.font="120px Arial";
 ctx.fillText("üéÖ",santa.x,santa.y+100);

 ctx.restore();
}

/* ================= END ================= */
function endGame() {
 gameStarted=false;
 endScreen.style.display="flex";

 const ranking = Object.values(players)
  .sort((a,b)=>b.score-a.score);

 endScreen.innerHTML =
  "<h1>üèÜ PUAN TABLOSU</h1>" +
  ranking.map((p,i)=>
   `<h2>${i+1}. ${p.name} - ${p.score}</h2>`
  ).join("");
}

/* ================= MOBILE ================= */
} else {

setup.style.display="none";
nameScreen.style.display="flex";

peer.on("open",()=>{
 const conn = peer.connect(peerId);

 joinBtn.onclick = ()=>{
  conn.send({type:"join",name:playerName.value});
  nameScreen.style.display="none";
  mobile.style.display="block";
 };

 const bind=(id,key)=>{
  const e=document.getElementById(id);
  e.ontouchstart=()=>conn.send({type:"key",key,pressed:true});
  e.ontouchend=()=>conn.send({type:"key",key,pressed:false});
 };

 bind("left","left");
 bind("right","right");
 bind("jump","up");
});
}
</script>

</body>
</html>
